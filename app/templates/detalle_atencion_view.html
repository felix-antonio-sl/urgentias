{% extends "base.html" %}
{% import 'macros.html' as macros %}
{% block title %}Detalle de Atención{% endblock %}
{% block content %}
<div class="container mx-auto p-4">
  <!-- Título de la Página -->
  <h1 class="text-3xl font-bold mb-6">Atención Actual</h1>

  <!-- Información del Paciente -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="card shadow-lg bg-base-100">
      <div class="card-body">
        <h4 class="card-title">RUN</h4>
        <p>{{ paciente.run }}</p>
      </div>
    </div>
    <div class="card shadow-lg bg-base-100">
      <div class="card-body">
        <h4 class="card-title">Nombre</h4>
        <p>{{ paciente.nombre or 'N/A' }}</p>
      </div>
    </div>
    <div class="card shadow-lg bg-base-100">
      <div class="card-body">
        <h4 class="card-title">Edad</h4>
        <p>
          {% if paciente.edad %}
          {{ paciente.edad }} años
          {% else %}
          N/A
          {% endif %}
        </p>
      </div>
    </div>
  </div>

  <!-- Pestañas -->
  <div class="tabs">
    <button class="tab tab-bordered tab-active"
      hx-get="{{ url_for('main.historia_clinica_route', atencion_id=atencion.id) }}" hx-target="#tabContent"
      hx-swap="innerHTML">Historia Clínica</button>
    <button class="tab tab-bordered" hx-get="{{ url_for('main.atencion_actual_route', atencion_id=atencion.id) }}"
      hx-target="#tabContent" hx-swap="innerHTML">Atención Actual</button>
    <button class="tab tab-bordered" hx-get="{{ url_for('main.asistencia_ia_route', atencion_id=atencion.id) }}"
      hx-target="#tabContent" hx-swap="innerHTML">AsistencIA</button>
  </div>

  <!-- Contenido Dinámico de las Tabs -->
  <div id="tabContent" class="mt-4">
    <!-- Contenido cargado dinámicamente con htmx -->
    <p class="text-center text-gray-500">Seleccione una pestaña para ver el contenido.</p>
  </div>

  <!-- Acciones Adicionales -->
  <div class="mt-6 flex justify-end space-x-2">
    <!-- Botón para Generar Reporte -->
    <button class="btn btn-secondary"
      hx-get="{{ url_for('main.generar_reporte_modal_route', atencion_id=atencion.id) }}"
      hx-target="#reporteModalContent" hx-swap="innerHTML">
      <i class="bi bi-file-earmark-text"></i> Generar Reporte
    </button>

    <!-- Botón para Cerrar Atención -->
    <button class="btn btn-error" hx-get="{{ url_for('main.cerrar_atencion_modal_route', atencion_id=atencion.id) }}"
      hx-target="#cierreAtencionModalContent" hx-swap="innerHTML">
      <i class="bi bi-x-circle"></i> Cerrar Atención
    </button>
  </div>

  <!-- Modal para Generar Reporte -->
  <input type="checkbox" id="reporteModal" class="modal-toggle" />
  <div class="modal" id="reporteModalContent">
    <!-- Contenido cargado dinámicamente con htmx -->
  </div>

  <!-- Modal para Cerrar Atención -->
  <input type="checkbox" id="cierreAtencionModal" class="modal-toggle" />
  <div class="modal" id="cierreAtencionModalContent">
    <!-- Contenido cargado dinámicamente con htmx -->
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Cargar la primera pestaña por defecto al cargar la página
  document.addEventListener('DOMContentLoaded', function () {
    const activeTab = document.querySelector('.tab-active');
    if (activeTab) {
      htmx.trigger(activeTab, 'click');
    }
  });

  // Manejar la confirmación antes de cerrar la atención
  document.body.addEventListener('htmx:beforeRequest', function (evt) {
    if (evt.detail.verb === 'POST' && evt.target.id === 'cierreAtencionForm') {
      if (!confirm('¿Está seguro de cerrar esta atención?')) {
        evt.preventDefault();
      }
    }
  });
</script>
{% endblock %}